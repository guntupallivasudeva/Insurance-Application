<div class="min-h-screen bg-gray-50 p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">{{ roleTitle }} Dashboard</h1>
      <p class="text-gray-600 mt-1">Welcome, <span class="font-semibold">{{ userName }}</span></p>
    </div>
    <div class="flex items-center gap-3">
      <button (click)="refreshAll()" class="p-2 rounded-full text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 transition-colors disabled:opacity-60" [disabled]="isLoading" aria-label="Refresh all" title="Refresh">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992V4.356M2.985 15.091v4.992h4.992M20.261 8.633A9 9 0 006.344 6.344M3.739 15.367A9 9 0 0017.656 17.656" />
        </svg>
      </button>
      <button (click)="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
        Logout
      </button>
    </div>
  </div>

  <!-- Database Status -->
  <div class="mb-8">
    <div class="bg-white rounded-lg shadow-md ring-1 ring-slate-200">
      <div class="flex items-center justify-between px-5 py-3 border-b border-slate-100">
        <div class="flex items-center gap-2">
          <span class="text-slate-700 font-semibold">Database Status</span>
          <span *ngIf="dbStatus?.connection as c" class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full"
            [ngClass]="{
              'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200': c.state === 'connected',
              'bg-amber-50 text-amber-700 ring-1 ring-amber-200': c.state === 'connecting',
              'bg-rose-50 text-rose-700 ring-1 ring-rose-200': c.state === 'disconnected' || c.state === 'disconnecting'
            }">
            <i class="fas fa-database"></i>
            <span class="uppercase tracking-wide">{{ c.state }}</span>
          </span>
        </div>
        <div class="text-xs text-slate-500">Server time: {{ dbStatus.serverTime | date:'medium' }}</div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-4 text-sm">
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 flex items-center justify-center rounded-full bg-sky-50 text-sky-600">
            <i class="fas fa-plug"></i>
          </div>
          <div>
            <div class="text-slate-600">Host</div>
            <div class="font-medium text-slate-800">{{ dbStatus.connection?.host || '-' }}</div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-600">
            <i class="fas fa-database"></i>
          </div>
          <div>
            <div class="text-slate-600">Database</div>
            <div class="font-medium text-slate-800">{{ dbStatus.connection?.dbName || '-' }}</div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 flex items-center justify-center rounded-full bg-emerald-50 text-emerald-600">
            <i class="fas fa-signal"></i>
          </div>
          <div>
            <div class="text-slate-600">State Code</div>
            <div class="font-medium text-slate-800">{{ dbStatus.connection?.code }}</div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="h-8 w-8 flex items-center justify-center rounded-full bg-amber-50 text-amber-600">
            <i class="fas fa-info-circle"></i>
          </div>
          <div>
            <div class="text-slate-600">State</div>
            <div class="font-medium text-slate-800 capitalize">{{ dbStatus.connection?.state }}</div>
          </div>
        </div>
      </div>

      <div class="px-4 pb-4" *ngIf="dbStatus?.counts as cts">
        <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-3">
          <div class="flex items-center gap-2 p-2 rounded-lg ring-1 ring-slate-100 bg-slate-50">
            <i class="fas fa-user text-slate-500"></i><span class="text-xs text-slate-600">Users</span>
            <span class="ml-auto text-sm font-semibold text-slate-800">{{ cts.users }}</span>
          </div>
          <div class="flex items-center gap-2 p-2 rounded-lg ring-1 ring-slate-100 bg-slate-50">
            <i class="fas fa-user-tie text-slate-500"></i><span class="text-xs text-slate-600">Agents</span>
            <span class="ml-auto text-sm font-semibold text-slate-800">{{ cts.agents }}</span>
          </div>
          <div class="flex items-center gap-2 p-2 rounded-lg ring-1 ring-slate-100 bg-slate-50">
            <i class="fas fa-user-shield text-slate-500"></i><span class="text-xs text-slate-600">Admins</span>
            <span class="ml-auto text-sm font-semibold text-slate-800">{{ cts.admins }}</span>
          </div>
          <div class="flex items-center gap-2 p-2 rounded-lg ring-1 ring-slate-100 bg-slate-50">
            <i class="fas fa-file-alt text-slate-500"></i><span class="text-xs text-slate-600">Policies</span>
            <span class="ml-auto text-sm font-semibold text-slate-800">{{ cts.policies }}</span>
          </div>
          <div class="flex items-center gap-2 p-2 rounded-lg ring-1 ring-slate-100 bg-slate-50">
            <i class="fas fa-id-card text-slate-500"></i><span class="text-xs text-slate-600">User Policies</span>
            <span class="ml-auto text-sm font-semibold text-slate-800">{{ cts.userPolicies }}</span>
          </div>
          <div class="flex items-center gap-2 p-2 rounded-lg ring-1 ring-slate-100 bg-slate-50">
            <i class="fas fa-clipboard-check text-slate-500"></i><span class="text-xs text-slate-600">Claims</span>
            <span class="ml-auto text-sm font-semibold text-slate-800">{{ cts.claims }}</span>
          </div>
          <div class="flex items-center gap-2 p-2 rounded-lg ring-1 ring-slate-100 bg-slate-50">
            <i class="fas fa-wallet text-slate-500"></i><span class="text-xs text-slate-600">Payments</span>
            <span class="ml-auto text-sm font-semibold text-slate-800">{{ cts.payments }}</span>
          </div>
          <div class="flex items-center gap-2 p-2 rounded-lg ring-1 ring-slate-100 bg-slate-50">
            <i class="fas fa-history text-slate-500"></i><span class="text-xs text-slate-600">Audit Logs</span>
            <span class="ml-auto text-sm font-semibold text-slate-800">{{ cts.auditLogs }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Stats -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
          </svg>
        </div>
        <div class="ml-4">
          <h3 class="text-lg font-semibold text-gray-900">Total Customers</h3>
          <p class="text-2xl font-bold text-indigo-600">{{ kpis.customers }}</p>
          <p class="text-sm text-gray-500">Registered Users</p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
          </svg>
        </div>
        <div class="ml-4">
          <h3 class="text-lg font-semibold text-gray-900">Available Policies</h3>
          <p class="text-2xl font-bold text-blue-600">{{ kpis.policies }}</p>
          <p class="text-sm text-gray-500">Policy Products</p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="ml-4">
          <h3 class="text-lg font-semibold text-gray-900">User Policies</h3>
          <p class="text-2xl font-bold text-purple-600">{{ kpis.userPolicies }}</p>
          <p class="text-sm text-gray-500">Active Policies</p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/>
          </svg>
        </div>
        <div class="ml-4">
          <h3 class="text-lg font-semibold text-gray-900">Total Claims</h3>
          <p class="text-2xl font-bold text-yellow-600">{{ kpis.claims }}</p>
          <p class="text-sm text-gray-500">Filed Claims</p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-green-100 text-green-600">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
          </svg>
        </div>
        <div class="ml-4">
          <h3 class="text-lg font-semibold text-gray-900">Total Payments</h3>
          <p class="text-2xl font-bold text-green-600">{{ kpis.totalPayments }}</p>
          <p class="text-sm text-gray-500">Payments Made</p>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-emerald-100 text-emerald-600">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="ml-4">
          <h3 class="text-lg font-semibold text-gray-900">Total Revenue</h3>
          <p class="text-2xl font-bold text-emerald-600">â‚¹{{ kpis.totalRevenue | number:'1.2-2' }}</p>
          <p class="text-sm text-gray-500">Revenue Generated</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="mb-1">
    <div class="border-b border-gray-200">
      <nav class="flex space-x-8">
        <button 
          (click)="setActiveTab('pending-policies')"
          [class]="activeTab === 'pending-policies' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="py-2 px-1 border-b-2 font-medium text-sm">
          Pending Policies
        </button>
        <button 
          (click)="setActiveTab('approved-policies')"
          [class]="activeTab === 'approved-policies' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="py-2 px-1 border-b-2 font-medium text-sm">
          Approved Policies
        </button>
        <button 
          (click)="setActiveTab('agents')"
          [class]="activeTab === 'agents' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="py-2 px-1 border-b-2 font-medium text-sm">
          Agents Management
        </button>
        <button 
          (click)="setActiveTab('policies')"
          [class]="activeTab === 'policies' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="py-2 px-1 border-b-2 font-medium text-sm">
          Policy Products
        </button>
        <button 
          (click)="setActiveTab('user-policies')"
          [class]="activeTab === 'user-policies' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="py-2 px-1 border-b-2 font-medium text-sm">
          User Policies
        </button>
        <button 
          (click)="setActiveTab('customers')"
          [class]="activeTab === 'customers' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="py-2 px-1 border-b-2 font-medium text-sm">
          Customers
        </button>
        <button 
          (click)="setActiveTab('claims')"
          [class]="activeTab === 'claims' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="py-2 px-1 border-b-2 font-medium text-sm">
          Claims Management
        </button>
      </nav>
    </div>
  </div>

  <!-- Policy Details Modal -->
    <div *ngIf="showPolicyModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="closePolicyModal()">
      <div class="w-full max-w-3xl scale-100 rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-800">Policy Details</h3>
          <button (click)="closePolicyModal()" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800">âœ•</button>
        </div>
        <div class="grid grid-cols-1 gap-4 text-sm md:grid-cols-2">
          <div class="space-y-1">
            <p><span class="font-medium text-slate-700">Policy ID:</span> {{ selectedPolicy?._id }}</p>
            <p><span class="font-medium text-slate-700">User:</span> {{ selectedPolicy?.userId?.name || selectedPolicy?.userId?.email || selectedPolicy?.userId }}</p>
            <p><span class="font-medium text-slate-700">Status:</span> {{ selectedPolicy?.status }}</p>
            <p><span class="font-medium text-slate-700">Verification:</span> {{ selectedPolicy?.verificationType }}</p>
          </div>
          <div class="space-y-1">
            <p><span class="font-medium text-slate-700">Product:</span> {{ selectedPolicy?.policyProductId?.title || selectedPolicy?.policyProductId?.code || selectedPolicy?.policyProductId }}</p>
            <p><span class="font-medium text-slate-700">Start:</span> {{ selectedPolicy?.startDate | date: 'medium' }}</p>
            <p><span class="font-medium text-slate-700">End:</span> {{ selectedPolicy?.endDate | date: 'medium' }}</p>
          </div>
        </div>
        <div class="mt-6 flex justify-end">
          <button (click)="closePolicyModal()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200">Close</button>
        </div>
      </div>
    </div>

  <!-- Pending User Policies Tab -->
  <div *ngIf="activeTab === 'pending-policies'" class="mt-8 bg-white rounded-lg shadow-md">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">Pending Policies</h2>
      <p class="text-gray-600 mt-1">Review and approve pending policy applications</p>
    </div>
    
    <div class="p-6">
  <div class="mb-2 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800">Policy Applications</h3>
      </div>
      <div *ngIf="policiesError" class="mb-3 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 shadow-sm">{{ policiesError }}</div>

      <div class="overflow-x-auto rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Policy ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Policy Code</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 bg-white" *ngIf="pendingPolicies?.length; else noPendingPolicies">
            <tr *ngFor="let p of pendingPolicies" class="hover:bg-slate-50/60">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ p._id }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ p.policyProductId?.code || policyByRef(p.policyProductId)?.code || 'â€”' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ p.userId?.name || p.userId?.email || p.userId || 'â€”' }}</td>
              <td class="px-6 py-4 text-sm text-gray-700">{{ p.policyProductId?.title || p.policyProductId?.code || p.policyProductId || 'â€”' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ p.startDate | date: 'mediumDate' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">{{ p.endDate | date: 'mediumDate' }}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-amber-100 text-amber-800">{{ p.status }}</span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex flex-wrap gap-2">
                  <button (click)="approvePolicy(p._id)" class="p-2 text-green-600 hover:text-green-900 hover:bg-green-50 rounded-lg transition-colors" aria-label="Approve policy" title="Approve">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                  </button>
                  <button (click)="rejectPolicy(p._id)" class="p-2 text-red-600 hover:text-red-900 hover:bg-red-50 rounded-lg transition-colors" aria-label="Reject policy" title="Reject">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                  <button (click)="viewPolicyDetails(p)" class="p-2 text-blue-600 hover:text-blue-900 hover:bg-blue-50 rounded-lg transition-colors" aria-label="View policy" title="View">
                    <i class="fas fa-eye w-5 h-5"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <ng-template #noPendingPolicies>
          <tbody>
            <tr>
              <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">No pending policies.</td>
            </tr>
          </tbody>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Approved Policies Tab -->
  <div *ngIf="activeTab === 'approved-policies'" class="mt-8 bg-white rounded-lg shadow-md">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">Approved Policies</h2>
      <p class="text-gray-600 mt-1">View recently approved policy applications</p>
    </div>
    
    <div class="p-6">
      <div class="mb-3 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800">Recently Approved Policies</h3>
      </div>
      <div *ngIf="approvedPoliciesError" class="mb-3 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">{{ approvedPoliciesError }}</div>
      <div class="overflow-x-auto rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Policy ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Policy Code</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approved By</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 bg-white" *ngIf="approvedPolicies?.length; else noApprovedPolicies">
            <tr *ngFor="let p of approvedPolicies" class="hover:bg-slate-50/60">
              <td class="px-4 py-3 text-sm text-slate-900">{{ p._id }}</td>
              <td class="px-4 py-3 text-sm text-slate-700">{{ p.policyProductId?.code || policyByRef(p.policyProductId)?.code || 'â€”' }}</td>
              <td class="px-4 py-3 text-sm text-slate-700">{{ p.userId?.name || p.userId?.email || p.userId || 'â€”' }}</td>
              <td class="px-4 py-3 text-sm text-slate-700">{{ p.policyProductId?.title || p.policyProductId?.code || p.policyProductId || 'â€”' }}</td>
              <td class="px-4 py-3 text-sm text-slate-700">{{ p.startDate | date: 'mediumDate' }}</td>
              <td class="px-4 py-3 text-sm text-slate-700">{{ p.endDate | date: 'mediumDate' }}</td>
              <td class="px-4 py-3 text-sm">
                <span class="rounded-full bg-emerald-100 px-2 py-1 text-xs font-medium text-emerald-800">{{ p.status }}</span>
              </td>
              <td class="px-4 py-3 text-sm">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                  [ngClass]="verificationService.getVerificationTypeClasses(p.verificationType)">
                  {{ verificationService.getVerificationTypeDisplay(p.verificationType) }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
        <ng-template #noApprovedPolicies>
          <div class="p-5 text-sm text-slate-600">No approved policies recently.</div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Agents Management Tab -->
  <div *ngIf="activeTab === 'agents'" class="mt-8 bg-white rounded-lg shadow-md">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">Agents Management</h2>
      <p class="text-gray-600 mt-1">Manage insurance agents and their assignments</p>
    </div>
    
    <div class="p-6">
      <div class="mb-6 flex items-center justify-between border-b border-slate-200 pb-4">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-indigo-100 text-indigo-600">ðŸ‘¤</div>
          <div>
            <h3 class="text-lg font-semibold text-slate-800">Agents</h3>
            <p class="text-sm text-slate-600">{{ agents.length || 0 }} total agents</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button (click)="openCreateAgent()" class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-4 py-2 text-white shadow-sm ring-1 ring-emerald-500/50 hover:bg-emerald-700 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5">
              <path fill-rule="evenodd" d="M12 3.75a8.25 8.25 0 100 16.5 8.25 8.25 0 000-16.5zM12.75 8.25a.75.75 0 00-1.5 0v3h-3a.75.75 0 000 1.5h3v3a.75.75 0 001.5 0v-3h3a.75.75 0 000-1.5h-3v-3z" clip-rule="evenodd" />
            </svg>
            Add Agent
          </button>
        </div>
      </div>
      <div *ngIf="agentsError" class="mb-3 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 shadow-sm">{{ agentsError }}</div>
      <div *ngIf="agentsLoading && !agents?.length" class="p-6 text-sm text-slate-600">Loading agents...</div>

      <div class="overflow-hidden rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm" *ngIf="agents?.length; else noAgentsBlock">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr class="divide-x divide-slate-200">
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Agent</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200 bg-white">
            <tr *ngFor="let a of agents" class="hover:bg-slate-50 transition-colors">
              <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                  <div class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 text-slate-600 text-xs font-medium">
                    {{ (a.name || a.email || 'A')?.slice(0,2) | uppercase }}
                  </div>
                  <div>
                    <div class="text-sm font-medium text-slate-800">{{ a.name }}</div>
                    <div class="text-xs font-mono text-slate-500">{{ a.agentCode || 'â€”' }}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 text-sm text-slate-700">{{ a.email }}</td>
              <td class="px-6 py-4 text-xs font-mono text-slate-500">{{ a._id }}</td>
              <td class="px-6 py-4">
                <div class="flex flex-wrap gap-2">
                  <button (click)="openAgentView(a)" class="p-2 text-indigo-600 hover:text-indigo-900 hover:bg-indigo-50 rounded-lg transition-colors" aria-label="View agent" title="View">
                    <i class="fas fa-eye w-5 h-5"></i>
                  </button>
                  <button (click)="openEditAgent(a)" class="p-2 text-green-600 hover:text-green-900 hover:bg-green-50 rounded-lg transition-colors" aria-label="Edit agent" title="Edit">
                    <i class="fas fa-edit w-5 h-5"></i>
                  </button>
                  <button (click)="openDeleteModal('agent', a)" class="p-2 text-red-600 hover:text-red-900 hover:bg-red-50 rounded-lg transition-colors" aria-label="Delete agent" title="Delete">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noAgentsBlock>
        <div class="p-8 text-center text-sm text-slate-600">No agents found. Click <span class="font-medium">Add Agent</span> to create one.</div>
      </ng-template>

      <!-- Manage Agent Modal -->
      <div *ngIf="manageAgentModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="closeManageAgentModal()">
        <div class="w-full max-w-lg rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
          <div class="mb-4 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-800">{{ agentFormMode === 'create' ? 'Add Agent' : 'Edit Agent' }}</h3>
            <button (click)="closeManageAgentModal()" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800">âœ•</button>
          </div>
          <div *ngIf="agentFormError" class="mb-3 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 shadow-sm">{{ agentFormError }}</div>
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Name</label>
              <input type="text" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="agentForm.name" (input)="onAgentNameInput()" [ngModelOptions]="{standalone:true}" placeholder="Agent Name" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Email</label>
              <input type="email" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="agentForm.email" (input)="onAgentEmailInput()" [ngModelOptions]="{standalone:true}" placeholder="agent@example.com" />
            </div>
            <!-- Agent Code (editable; digits-only input; 'AGT' prefix shown) -->
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Agent Code</label>
              <div class="flex items-center rounded-xl border border-slate-300 overflow-hidden">
                <span class="px-3 text-slate-600 select-none">AGT</span>
                <input type="text" class="w-full p-2.5 outline-none" [(ngModel)]="agentCodeDigits" (input)="onAgentCodeDigitsInput()" [ngModelOptions]="{standalone:true}" placeholder="01" inputmode="numeric" pattern="[0-9]{2,}" title="Enter at least two digits (e.g., 01)" />
              </div>
              <p class="mt-1 text-[11px] text-slate-500">Type the number only (e.g., 01). Weâ€™ll save it as AGT01.</p>
            </div>
            <div *ngIf="agentFormMode === 'create'">
              <label class="mb-1 block text-sm font-medium text-slate-700">Password (default)</label>
              <input type="text" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="agentForm.password" [ngModelOptions]="{standalone:true}" placeholder="agent123" />
              <p class="mt-1 text-[11px] text-slate-500">You can change this before saving. It defaults to <span class="font-mono">agent123</span>.</p>
            </div>
            <div *ngIf="agentFormMode === 'edit'">
              <label class="mb-1 block text-sm font-medium text-slate-700">New Password (optional)</label>
              <input type="password" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="agentForm.password" [ngModelOptions]="{standalone:true}" placeholder="Leave blank to keep existing" />
            </div>
            <div class="md:col-span-2" *ngIf="policies?.length">
              <label class="mb-1 block text-sm font-medium text-slate-700">Assign Policy (optional)</label>
              <select class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="agentForm.assignedPolicyId" [ngModelOptions]="{standalone:true}">
                <option value="">-- select a policy to assign --</option>
                <option *ngFor="let p of policies" [value]="p._id">{{ p.code }} - {{ p.title }}</option>
              </select>
              <p class="mt-1 text-[11px] text-slate-500">Choose one policy to auto-assign after the agent is saved.</p>
            </div>
            <!-- Branch & Phone inputs removed -->
          </div>
          <div class="mt-6 flex justify-end gap-2">
            <button (click)="closeManageAgentModal()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200">Cancel</button>
            <button (click)="saveAgent()" class="rounded-full bg-indigo-600 px-4 py-2 text-white shadow-sm ring-1 ring-indigo-500/50 hover:bg-indigo-700">Save</button>
          </div>
        </div>
      </div>

      <!-- Assign Agent to Policies (moved from Policy Products tab) -->
      <div class="mt-10">
        <div class="mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between border-b border-slate-200 pb-4">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-indigo-100 text-indigo-600">ðŸ§©</div>
            <div>
              <h2 class="text-xl font-semibold text-slate-800">Assign Agent to Policies</h2>
              <p class="text-sm text-slate-600">{{ policies.length || 0 }} policies</p>
            </div>
          </div>
          
        </div>

        <div class="overflow-x-auto rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
          <table class="min-w-full divide-y divide-slate-200">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Code</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Title</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Assigned Agent</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 bg-white" *ngIf="policies?.length; else noAssignPolicies">
              <tr *ngFor="let p of policies" class="hover:bg-slate-50/60">
                <td class="px-4 py-3 text-sm text-slate-900">
                  <div class="flex items-center gap-2">
                    <div class="flex h-7 w-7 items-center justify-center rounded-full bg-amber-100 text-amber-700 text-[11px] font-semibold">
                      {{ (p.code || 'PO').slice(0,2).toUpperCase() }}
                    </div>
                    <span>{{ p.code }}</span>
                  </div>
                </td>
                <td class="px-4 py-3 text-sm text-slate-700">{{ p.title }}</td>
                <td class="px-4 py-3 text-sm text-slate-700">
                  <ng-container *ngIf="p.assignedAgentName; else unassignedPolicy">{{ p.assignedAgentName }}</ng-container>
                  <ng-template #unassignedPolicy>â€”</ng-template>
                </td>
                <td class="px-4 py-3 text-sm">
                  <div class="flex flex-wrap gap-2">
                    <button (click)="openPolicyProductView(p)" class="p-2 text-indigo-600 hover:text-indigo-900 hover:bg-indigo-50 rounded-lg transition-colors" aria-label="View policy" title="View">
                      <i class="fas fa-eye w-5 h-5"></i>
                    </button>
                    <button (click)="openAssignAgent(p)" class="p-2 text-purple-600 hover:text-purple-900 hover:bg-purple-50 rounded-lg transition-colors" aria-label="Assign agent" title="Assign">
                      <i class="fas fa-user-plus w-5 h-5"></i>
                    </button>
                    <button *ngIf="p.assignedAgentId || p.assignedAgentName" (click)="openUnassignModal(p)" class="p-2 text-red-600 hover:text-red-900 hover:bg-red-50 rounded-lg transition-colors" aria-label="Remove agent" title="Remove">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <ng-template #noAssignPolicies>
            <div class="p-8 text-center text-sm text-slate-600">No policies available for assignment.</div>
          </ng-template>
        </div>
      </div>

    </div>
  </div>

  <!-- Policy Products Tab -->
  <div *ngIf="activeTab === 'policies'" class="mt-8 bg-white rounded-lg shadow-md">
    <div class="p-6 border-b border-slate-200">
      <h2 class="text-xl font-semibold text-slate-900">Policy Products</h2>
      <p class="text-slate-600 mt-1">Manage insurance policy products and assignments</p>
    </div>
    
    <div class="p-6">
      <div class="mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between border-b border-slate-200 pb-4">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-amber-100 text-amber-600">ðŸ“¦</div>
          <div>
            <h3 class="text-lg font-semibold text-slate-800">Policies</h3>
            <p class="text-sm text-slate-600">{{ policies.length || 0 }} total</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button (click)="openCreatePolicy()" class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-4 py-2 text-white shadow-sm ring-1 ring-emerald-500/50 hover:bg-emerald-700 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5">
              <path fill-rule="evenodd" d="M12 3.75a8.25 8.25 0 100 16.5 8.25 8.25 0 000-16.5zM12.75 8.25a.75.75 0 00-1.5 0v3h-3a.75.75 0 000 1.5h3v3a.75.75 0 001.5 0v-3h3a.75.75 0 000-1.5h-3v-3z" clip-rule="evenodd" />
            </svg>
            Add Policy
          </button>
        </div>
      </div>

      <div *ngIf="policiesCrudError" class="mb-3 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 shadow-sm">{{ policiesCrudError }}</div>

      <div class="overflow-x-auto rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm">
        <table class="min-w-full divide-y divide-slate-200">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Code</th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Title</th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Premium</th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Term (Months)</th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Min Sum Insured</th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 bg-white" *ngIf="policies?.length; else noPoliciesCrud">
            <tr *ngFor="let p of policies" class="hover:bg-slate-50/60">
              <td class="px-4 py-3 text-sm text-slate-900">
                <div class="flex items-center gap-2">
                  <div class="flex h-7 w-7 items-center justify-center rounded-full bg-amber-100 text-amber-700 text-[11px] font-semibold">
                    {{ (p.code || 'PO').slice(0,2).toUpperCase() }}
                  </div>
                  <span>{{ p.code }}</span>
                </div>
              </td>
              <td class="px-4 py-3 text-sm text-slate-700">{{ p.title }}</td>
              <td class="px-4 py-3 text-sm text-slate-700">â‚¹{{ p.premium }}</td>
              <td class="px-4 py-3 text-sm text-slate-700">{{ p.termMonths }}</td>
              <td class="px-4 py-3 text-sm text-slate-700">{{ p.minSumInsured ?? 0 }}</td>
              <td class="px-4 py-3 text-sm">
                <div class="flex flex-wrap gap-2">
                  <button (click)="openPolicyProductView(p)" class="p-2 text-blue-600 hover:text-blue-900 hover:bg-blue-50 rounded-lg transition-colors" aria-label="View policy" title="View">
                    <i class="fas fa-eye w-5 h-5"></i>
                  </button>
                  <button (click)="openAssignAgent(p)" class="p-2 text-purple-600 hover:text-purple-900 hover:bg-purple-50 rounded-lg transition-colors" aria-label="Assign agent" title="Assign">
                    <i class="fas fa-user-plus w-5 h-5"></i>
                  </button>
                  <button (click)="openEditPolicy(p)" class="p-2 text-green-600 hover:text-green-900 hover:bg-green-50 rounded-lg transition-colors" aria-label="Edit policy" title="Edit">
                    <i class="fas fa-edit w-5 h-5"></i>
                  </button>
                  <button (click)="openDeleteModal('policy', p)" class="p-2 text-red-600 hover:text-red-900 hover:bg-red-50 rounded-lg transition-colors" aria-label="Delete policy" title="Delete">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <ng-template #noPoliciesCrud>
          <div class="p-8 text-center text-sm text-slate-600">No policies found.</div>
        </ng-template>
      </div>

      <!-- Manage Policy Modal -->
      <div *ngIf="managePolicyModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="closeManagePolicyModal()">
        <div class="w-full max-w-xl rounded-2xl bg-white p-4 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
          <div class="mb-3 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-800">{{ policyFormMode === 'create' ? 'Add Policy' : 'Edit Policy' }}</h3>
            <button (click)="closeManagePolicyModal()" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800">âœ•</button>
          </div>
          <div *ngIf="policyFormError" class="mb-3 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 shadow-sm">{{ policyFormError }}</div>
          <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
            <div *ngIf="policyFormMode === 'create'; else editCodeBlock">
              <label class="mb-1 block text-sm font-medium text-slate-700">Policy Code</label>
              <div class="flex items-center rounded-xl border border-slate-300 overflow-hidden">
                <span class="px-3 text-slate-600 select-none">POL</span>
                <input type="text" class="w-full p-2.5 outline-none" [(ngModel)]="policyCodeDigits" (input)="onPolicyCodeDigitsInput()" [ngModelOptions]="{standalone:true}" placeholder="01" inputmode="numeric" pattern="[0-9]{2,}" title="Enter at least two digits (e.g., 01)" />
              </div>
              <p class="mt-1 text-[11px] text-slate-500">Type the number only (e.g., 01). We'll save it as POL01. Auto-generated but editable.</p>
            </div>
            <ng-template #editCodeBlock>
              <label class="mb-1 block text-sm font-medium text-slate-700">Code Number</label>
              <div class="flex items-center gap-2">
                <span class="rounded-lg bg-slate-100 px-2 py-2 text-xs font-semibold text-slate-600 ring-1 ring-slate-200 select-none">POL</span>
                <input type="text" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="policyCodeDigits" [ngModelOptions]="{standalone:true}" placeholder="01" (input)="onCodeDigitsChange()" />
              </div>
              <p class="mt-1 text-[11px] text-slate-500">Current full code: <span class="font-mono">{{ policyForm.code }}</span></p>
            </ng-template>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Title</label>
              <input type="text" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="policyForm.title" [ngModelOptions]="{standalone:true}" placeholder="Policy Title" />
            </div>
            <div class="md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-slate-700">Description</label>
              <textarea rows="2" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="policyForm.description" [ngModelOptions]="{standalone:true}" placeholder="Short description"></textarea>
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Premium</label>
              <input type="number" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="policyForm.premium" [ngModelOptions]="{standalone:true}" placeholder="1000" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Term (Months)</label>
              <input type="number" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="policyForm.termMonths" [ngModelOptions]="{standalone:true}" placeholder="12" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Min Sum Insured</label>
              <input type="number" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="policyForm.minSumInsured" [ngModelOptions]="{standalone:true}" placeholder="50000" />
            </div>
            <div>
              <label class="mb-1 block text-sm font-medium text-slate-700">Max Sum Insured</label>
              <input type="number" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="policyForm.maxSumInsured" [ngModelOptions]="{standalone:true}" placeholder="1000000" />
            </div>
            <div class="md:col-span-2">
              <label class="mb-1 block text-sm font-medium text-slate-700">Assign Agent (Optional)</label>
              <select class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="policyForm.assignedAgentId" [ngModelOptions]="{standalone:true}">
                <option value="">-- No Agent Assigned --</option>
                <option *ngFor="let agent of agents" [value]="agent._id">{{ agent.name }} - ({{ agent.agentCode }})</option>
              </select>
              <p class="mt-1 text-[11px] text-slate-500">You can assign an agent to this policy now or later</p>
            </div>
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button (click)="closeManagePolicyModal()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200">Cancel</button>
            <button (click)="savePolicy()" class="rounded-full bg-indigo-600 px-4 py-2 text-white shadow-sm ring-1 ring-indigo-500/50 hover:bg-indigo-700">Save</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- User Policies Tab -->
  <div *ngIf="activeTab === 'user-policies'" class="mt-8 bg-white rounded-lg shadow-md">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">User Policies</h2>
      <p class="text-gray-600 mt-1">Overview of all customer policies and their details</p>
    </div>
    
    <div class="p-6">
      <div class="mb-3 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <h3 class="text-lg font-semibold text-gray-800">User Policies (All Customers)</h3>
          <div class="flex items-center gap-2 w-full md:w-auto">
            <input type="text" [(ngModel)]="userPoliciesSearch" [ngModelOptions]="{standalone:true}" placeholder="Search by name or email" class="w-full md:w-64 rounded-full border border-slate-300 bg-white/70 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>
        </div>
        <div *ngIf="customerDetailsError" class="mb-3 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 shadow-sm">{{ customerDetailsError }}</div>
        <div *ngIf="customerDetailsLoading" class="p-5 text-sm text-slate-600">Loading user policies...</div>
        <div class="overflow-x-auto rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm" *ngIf="!customerDetailsLoading && filteredUserPoliciesCustomers?.length; else noUserPoliciesOverview">
          <table class="min-w-full divide-y divide-slate-200">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Customer</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Email</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Total</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Approved</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Pending</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Cancelled</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Claimed</th>
                <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 bg-white">
              <!-- user policies overview rows -->
              <tr *ngFor="let c of filteredUserPoliciesCustomers" class="hover:bg-slate-50/60">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                    <div class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 text-slate-600 text-xs font-medium">
                      {{ (c?.customer?.name || c?.customer?.email || 'U').slice(0,2).toUpperCase() }}
                    </div>
                    <div class="text-sm font-medium text-slate-800">{{ c?.customer?.name || 'â€”' }}</div>
                  </div>
                </td>
                <td class="px-6 py-4 text-sm text-slate-700 break-all">{{ c?.customer?.email || 'â€”' }}</td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-xs font-medium text-slate-700 ring-1 ring-slate-300">{{ c?.policies?.length || 0 }}</span>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-medium text-emerald-800 ring-1 ring-emerald-600/20">{{ policyCountByStatus(c?.policies, 'approved') }}</span>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-medium text-amber-800 ring-1 ring-amber-600/20">{{ policyCountByStatus(c?.policies, 'pending') }}</span>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center rounded-full bg-rose-100 px-2.5 py-0.5 text-xs font-medium text-rose-800 ring-1 ring-rose-600/20">{{ policyCountByStatus(c?.policies, 'cancelled') }}</span>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center rounded-full bg-rose-100 px-2.5 py-0.5 text-xs font-medium text-rose-800 ring-1 ring-rose-600/20">{{ policyCountClaimed(c?.policies) }}</span>
                </td>
                <td class="px-6 py-4">
                  <button (click)="openUserPoliciesModal(c)" class="p-2 text-blue-600 hover:text-blue-900 hover:bg-blue-50 rounded-lg transition-colors" aria-label="View user policies" title="View">
                    <i class="fas fa-eye w-5 h-5"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noUserPoliciesOverview>
          <div class="p-5 text-sm text-slate-600 rounded-xl ring-1 ring-slate-200 bg-white">No user policies found.</div>
        </ng-template>
      </div>
    </div>
  

  <!-- Customers Tab -->
  <div *ngIf="activeTab === 'customers'" class="mt-8 bg-white rounded-lg shadow-md">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">Customers</h2>
      <p class="text-gray-600 mt-1">View and manage customer information and policies</p>
    </div>
    
  <div class="p-6">
    <div class="mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between border-b border-slate-200 pb-4">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-indigo-100 text-indigo-600">ðŸ‘¥</div>
          <div>
            <h3 class="text-lg font-semibold text-slate-800">Customer Management</h3>
            <p class="text-sm text-slate-600">{{ customerDetails.length || 0 }} total customers</p>
          </div>
        </div>
        <div class="flex items-center gap-2 w-full md:w-auto">
          <input type="text" placeholder="Search customers by name or email..." class="w-full md:w-64 rounded-full border border-slate-300 bg-white/70 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
      </div>
      
      <div *ngIf="customerDetailsError" class="mb-3 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 shadow-sm">{{ customerDetailsError }}</div>
      <div *ngIf="customerDetailsLoading && !customerDetails?.length" class="p-4 text-sm text-slate-600">Loading customers...</div>

      <div class="overflow-hidden rounded-2xl bg-white ring-1 ring-slate-200 shadow-sm" *ngIf="customerDetails?.length; else noCustomersBlock">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr class="divide-x divide-slate-200">
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Customer</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Contact</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Policies</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Payments</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Revenue</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200 bg-white">
            <tr *ngFor="let c of customerDetails" class="hover:bg-slate-50 transition-colors">
              <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                  <div class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 text-slate-600 text-xs font-medium">
                    {{ (c?.customer?.name || c?.customer?.email || 'U').slice(0,2).toUpperCase() }}
                  </div>
                  <div>
                    <div class="text-sm font-medium text-slate-800">{{ c?.customer?.name || 'Unknown' }}</div>
                    <div class="text-[11px] font-mono text-slate-500">ID: {{ c?.customer?._id }}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 text-sm text-slate-700 break-all">{{ c?.customer?.email || 'No email' }}</td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center rounded-full bg-sky-100 px-2.5 py-0.5 text-xs font-medium text-sky-800 ring-1 ring-sky-600/20">{{ c?.policies?.length || 0 }} policies</span>
              </td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-medium text-emerald-800 ring-1 ring-emerald-600/20">{{ c?.payments?.length || 0 }} payments</span>
              </td>
              <td class="px-6 py-4 text-sm font-medium text-emerald-600">â‚¹{{ getCustomerTotalPaid(c) | number:'1.2-2' }}</td>
              <td class="px-6 py-4">
                <div class="flex flex-wrap gap-2">
                  <button (click)="openCustomerModal(c)" class="p-2 text-blue-600 hover:text-blue-900 hover:bg-blue-50 rounded-lg transition-colors" aria-label="View customer" title="View">
                    <i class="fas fa-eye w-5 h-5"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noCustomersBlock>
        <div class="p-8 text-center text-sm text-slate-600">No customers found. Customer data will appear here once available.</div>
      </ng-template>
    </div>
  </div>

  <!-- Customer Details Modal -->
  <div *ngIf="showCustomerModal" class="fixed inset-0 z-50 flex items-start md:items-center justify-center bg-black/40 backdrop-blur-sm overflow-auto py-10" (click)="closeCustomerModal()">
  <div class="w-full max-w-4xl rounded-xl bg-white p-5 shadow-xl ring-1 ring-slate-200 md:max-h-[85vh] overflow-auto" (click)="$event.stopPropagation()">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-800">Customer Details</h3>
          <button (click)="closeCustomerModal()" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800">âœ•</button>
        </div>
        <div *ngIf="selectedCustomer" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
              <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Customer</div>
              <div class="text-sm font-semibold text-slate-800">{{ selectedCustomer.customer?.name }}</div>
              <div class="text-xs text-slate-600 break-all">{{ selectedCustomer.customer?.email }}</div>
              <div class="mt-1 text-[11px] font-mono text-slate-500">ID: {{ selectedCustomer.customer?._id }}</div>
            </div>
            <div class="rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
              <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Stats</div>
              <div class="text-xs text-slate-600">Policies: <span class="font-medium text-slate-800">{{ selectedCustomer.policies?.length || 0 }}</span></div>
              <div class="text-xs text-slate-600">Payments: <span class="font-medium text-slate-800">{{ selectedCustomer.payments?.length || 0 }}</span></div>
            </div>
            <div class="rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
              <div class="text-xs uppercase tracking-wide text-slate-500 mb-1">Notes</div>
              <div class="text-[11px] text-slate-600">Click columns to sort (future enhancement).</div>
            </div>
          </div>

          <!-- Policies Table -->
          <div>
            <div class="mb-2 text-sm font-semibold text-slate-700">Policies</div>
            <div class="overflow-x-auto rounded-xl ring-1 ring-slate-200">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Code</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Title</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Premium</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Term</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Start</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">End</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Status</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Assigned Agent</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white" *ngIf="selectedCustomer?.policies?.length; else noPoliciesModal">
                  <tr *ngFor="let p of selectedCustomer?.policies" class="hover:bg-slate-50/60">
                    <td class="px-3 py-2 text-sm text-slate-900">{{ (p?._product?.code) || 'â€”' }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ (p?._product?.title) || 'â€”' }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">â‚¹{{ (p?._product?.premium) ?? p?.premiumPaid ?? 'â€”' }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ p?._product?.termMonths ? (p?._product?.termMonths + ' mo') : 'â€”' }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ p?.startDate | date: 'mediumDate' }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ p?.endDate | date: 'mediumDate' }}</td>
                    <td class="px-3 py-2 text-sm">
                      <span class="rounded-full px-2 py-1 text-xs font-medium"
                        [ngClass]="{
                          'bg-amber-50 text-amber-700 ring-1 ring-amber-200': (p?.status || '').toLowerCase() === 'pending',
                          'bg-rose-50 text-rose-700 ring-1 ring-rose-200': ['claimed','cancelled'].includes((p?.status || '').toLowerCase()),
                          'bg-slate-100 text-slate-700 ring-1 ring-slate-300': (p?.status || '').toLowerCase() === 'expired'}">{{ p?.status || 'â€”' }}</span>
                    </td>
                    <td class="px-3 py-2 text-sm text-slate-700">
                      <ng-container *ngIf="p?.assignedAgentId; else agentFromProductModal">
                        {{ p?.assignedAgentId?.name || 'â€”' }} <span class="text-slate-500">({{ p?.assignedAgentId?.email || 'â€”' }})</span>
                      </ng-container>
                      <ng-template #agentFromProductModal>
                        <ng-container *ngIf="p?._product?.assignedAgentName; else noAgentModal">{{ p?._product?.assignedAgentName }}</ng-container>
                      </ng-template>
                      <ng-template #noAgentModal>â€”</ng-template>
                    </td>
                  </tr>
                </tbody>
              </table>
              <ng-template #noPoliciesModal>
                <div class="p-4 text-sm text-slate-600">No policies for this customer.</div>
              </ng-template>
            </div>
          </div>

          <!-- Payments Table -->
          <div>
            <div class="mb-2 text-sm font-semibold text-slate-700">Payments</div>
            <div class="overflow-x-auto rounded-xl ring-1 ring-slate-200">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Amount</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Date</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Method</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white" *ngIf="selectedCustomer?.payments?.length; else noPaymentsModal">
                  <tr *ngFor="let pay of selectedCustomer?.payments" class="hover:bg-slate-50/60">
                    <td class="px-3 py-2 text-sm text-slate-900">â‚¹{{ pay?.amount || 0 }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ pay?.createdAt | date: 'mediumDate' }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ pay?.method || 'Simulated' }}</td>
                  </tr>
                </tbody>
              </table>
              <ng-template #noPaymentsModal>
                <div class="p-4 text-sm text-slate-600">No payments for this customer.</div>
              </ng-template>
            </div>
          </div>

          <div class="flex justify-end mt-4">
            <button (click)="closeCustomerModal()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- User Policies Modal -->
    <div *ngIf="showUserPoliciesModal" class="fixed inset-0 z-50 flex items-start md:items-center justify-center bg-black/40 backdrop-blur-sm overflow-auto py-10" (click)="closeUserPoliciesModal()">
      <div class="w-full max-w-5xl rounded-xl bg-white p-5 shadow-xl ring-1 ring-slate-200 md:max-h-[85vh] overflow-auto" (click)="$event.stopPropagation()">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-800">User Policies - {{ selectedUserPoliciesCustomer?.customer?.name || 'Customer' }}</h3>
          <button (click)="closeUserPoliciesModal()" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800">âœ•</button>
        </div>
        <div *ngIf="selectedUserPoliciesCustomer" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-xs">
            <div class="rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
              <div class="uppercase tracking-wide text-slate-500 mb-1">Customer</div>
              <div class="text-sm font-semibold text-slate-800">{{ selectedUserPoliciesCustomer.customer?.name }}</div>
              <div class="text-[11px] text-slate-600 break-all">{{ selectedUserPoliciesCustomer.customer?.email }}</div>
              <div class="mt-1 text-[11px] font-mono text-slate-500">ID: {{ selectedUserPoliciesCustomer.customer?._id }}</div>
            </div>
            <div class="rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
              <div class="uppercase tracking-wide text-slate-500 mb-1">Total Policies</div>
              <div class="text-lg font-semibold text-slate-800">{{ selectedUserPoliciesCustomer.policies?.length || 0 }}</div>
            </div>
            <div class="rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
              <div class="uppercase tracking-wide text-slate-500 mb-1">Approved</div>
              <div class="text-lg font-semibold text-emerald-600">{{ policyCountByStatus(selectedUserPoliciesCustomer.policies, 'approved') }}</div>
            </div>
            <div class="rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
              <div class="uppercase tracking-wide text-slate-500 mb-1">Pending</div>
              <div class="text-lg font-semibold text-amber-600">{{ policyCountByStatus(selectedUserPoliciesCustomer.policies, 'pending') }}</div>
            </div>
          </div>

          <!-- Policies Table -->
          <div>
            <div class="mb-2 text-sm font-semibold text-slate-700">Policies</div>
            <div class="overflow-x-auto rounded-xl ring-1 ring-slate-200">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Policy ID</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Product</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Start</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">End</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Status</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Premium</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white" *ngIf="selectedUserPoliciesCustomer?.policies?.length; else noUserPoliciesRows">
                  <tr *ngFor="let p of selectedUserPoliciesCustomer?.policies" class="hover:bg-slate-50/60">
                    <td class="px-3 py-2 text-sm font-mono text-slate-700">{{ p?._id || 'â€”' }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ p?.policyProductId?.title || p?.policyProductId?.code || p?.policyProductId || p?._product?.title || p?._product?.code || 'â€”' }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ p?.startDate | date: 'mediumDate' }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ p?.endDate | date: 'mediumDate' }}</td>
                    <td class="px-3 py-2 text-sm">
                      <span class="rounded-full px-2 py-1 text-xs font-medium"
                        [ngClass]="{
                          'bg-amber-50 text-amber-700 ring-1 ring-amber-200': (p?.status || '').toLowerCase() === 'pending',
                          'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200': (p?.status || '').toLowerCase() === 'approved',
                          'bg-rose-50 text-rose-700 ring-1 ring-rose-200': ['claimed','cancelled'].includes((p?.status || '').toLowerCase()),
                          'bg-slate-100 text-slate-700 ring-1 ring-slate-300': (p?.status || '').toLowerCase() === 'expired'
                        }">{{ p?.status || 'â€”' }}</span>
                    </td>
                    <td class="px-3 py-2 text-sm text-slate-700">â‚¹{{ p?.premiumPaid || p?.policyProductId?.premium || p?._product?.premium || 'â€”' }}</td>
                  </tr>
                </tbody>
              </table>
              <ng-template #noUserPoliciesRows>
                <div class="p-4 text-sm text-slate-600">No policies.</div>
              </ng-template>
            </div>
          </div>

          <!-- Payments Summary -->
          <div>
            <div class="mb-2 text-sm font-semibold text-slate-700">Payments</div>
            <div class="overflow-x-auto rounded-xl ring-1 ring-slate-200">
              <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Amount</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Date Paid</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Due Month</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Next Due Month</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Status</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider text-slate-500">Method</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white" *ngIf="selectedUserPoliciesCustomer?.payments?.length; else noUserPoliciesPayments">
                  <tr *ngFor="let pay of selectedUserPoliciesCustomer?.payments; let i = index" class="hover:bg-slate-50/60">
                    <td class="px-3 py-2 text-sm text-slate-900">â‚¹{{ pay?.amount || 0 }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ pay?.datePaid ? (pay.datePaid | date: 'mediumDate') : (pay?.createdAt | date: 'mediumDate') }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ computeDueDate(pay) | date: 'MMM yyyy' }}</td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ computeNextDueDate(pay) | date: 'MMM yyyy' }}</td>
                    <td class="px-3 py-2 text-sm">
                      <span class="rounded-full px-2 py-1 text-xs font-medium"
                        [ngClass]="paymentService.getPaymentStatusClasses(paymentService.computePaymentStatus(pay))">{{ paymentService.computePaymentStatus(pay) }}</span>
                    </td>
                    <td class="px-3 py-2 text-sm text-slate-700">{{ pay?.method || 'Simulated' }}</td>
                  </tr>
                </tbody>
              </table>
              <ng-template #noUserPoliciesPayments>
                <div class="p-4 text-sm text-slate-600">No payments for this customer.</div>
              </ng-template>
            </div>
          </div>

          <div class="flex justify-end mt-4">
            <button (click)="closeUserPoliciesModal()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Unified Delete Confirmation Modal -->
    <div *ngIf="showDeleteModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="!deleteLoading && closeDeleteModal()">
      <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-800">Confirm Deletion</h3>
          <button (click)="closeDeleteModal()" [disabled]="deleteLoading" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800 disabled:opacity-50">âœ•</button>
        </div>
        <div class="space-y-4 text-sm text-slate-700">
          <p>
            Are you sure you want to permanently delete this
            <span class="font-medium" *ngIf="deleteTargetType === 'policy'">policy</span>
            <span class="font-medium" *ngIf="deleteTargetType === 'agent'">agent</span>? This action cannot be undone.
          </p>
          <div class="rounded-xl bg-slate-50 p-4 text-xs text-slate-600 ring-1 ring-slate-200" *ngIf="deleteTarget">
            <ng-container [ngSwitch]="deleteTargetType">
              <div *ngSwitchCase="'policy'">
                <div><span class="font-semibold text-slate-700">Code:</span> {{ deleteTarget?.code }}</div>
                <div><span class="font-semibold text-slate-700">Title:</span> {{ deleteTarget?.title || 'â€”' }}</div>
                <div *ngIf="deleteTarget?.premium != null"><span class="font-semibold text-slate-700">Premium:</span> â‚¹{{ deleteTarget?.premium }}</div>
              </div>
              <div *ngSwitchCase="'agent'">
                <div><span class="font-semibold text-slate-700">Name:</span> {{ deleteTarget?.name }}</div>
                <div><span class="font-semibold text-slate-700">Email:</span> {{ deleteTarget?.email }}</div>
                <div class="mt-1 text-[11px] font-mono text-slate-500">ID: {{ deleteTarget?._id }}</div>
              </div>
            </ng-container>
          </div>
          <div class="flex items-center gap-2 text-xs" *ngIf="deleteLoading">
            <svg class="h-4 w-4 animate-spin text-indigo-600" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
            </svg>
            <span>Deleting...</span>
          </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
          <button (click)="closeDeleteModal()" [disabled]="deleteLoading" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200 disabled:opacity-50">Cancel</button>
          <button (click)="confirmDelete()" [disabled]="deleteLoading" class="rounded-full bg-rose-600 px-4 py-2 text-white shadow-sm ring-1 ring-rose-500/50 hover:bg-rose-700 disabled:opacity-50">{{ deleteLoading ? 'Deleting...' : 'Delete' }}</button>
        </div>
      </div>
    </div>
  
  <!-- Claims Management Tab -->
  <div *ngIf="activeTab === 'claims'" class="mt-8 bg-white rounded-lg shadow-md">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900">Claims Management</h2>
      <p class="text-gray-600 mt-1">Process and manage insurance claims from customers</p>
    </div>
    
    <div class="p-6">
      <div class="mb-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Claims Processing</h3>
        <div class="flex items-center gap-2 w-full md:w-auto">
          <input type="text" placeholder="Search claims by customer or policy..." class="w-full md:w-64 rounded-full border border-slate-300 bg-white/70 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          
        </div>
      </div>

      <!-- Pending Claims Section -->
      <div class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200">
        <div class="flex items-center justify-between border-b border-slate-200 p-6">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-amber-100 text-amber-600">
              â³
            </div>
            <div>
              <h3 class="text-lg font-semibold text-slate-800">Pending Claims</h3>
              <p class="text-sm text-slate-600">Claims awaiting review and approval</p>
            </div>
          </div>
          <div class="text-sm text-slate-600">{{ pendingClaims.length || 0 }} pending</div>
        </div>
        
        <div *ngIf="pendingError" class="mx-6 mt-4 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 shadow-sm">{{ pendingError }}</div>
        <div *ngIf="isLoadingPending && !pendingClaims?.length" class="p-6 text-sm text-slate-600">Loading claims...</div>

        <div class="overflow-hidden" *ngIf="pendingClaims?.length; else noPendingClaimsBlock">
          <table class="w-full">
            <thead class="bg-slate-50">
              <tr class="divide-x divide-slate-200">
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Claim</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Customer</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Policy</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Amount</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 bg-white">
              <tr *ngFor="let c of pendingClaims" class="hover:bg-slate-50 transition-colors">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                    <div class="flex h-8 w-8 items-center justify-center rounded-full bg-amber-100 text-amber-600 text-xs font-medium">
                      â³
                    </div>
                    <div>
                      <div class="text-sm font-medium text-slate-800">{{ c._id }}</div>
                      <div class="text-xs text-slate-500">{{ c.incidentDate | date:'mediumDate' }}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 text-sm text-slate-700">{{ c.userId?.name || c.userId?.email || c.userId }}</td>
                <td class="px-6 py-4">
                  <div class="text-sm font-medium text-slate-800">{{ c._policyCode || c.userPolicyId?.policyProductId?.code || 'N/A' }}</div>
                  <div class="text-xs text-slate-500">{{ c._policyTitle || c.userPolicyId?.policyProductId?.title || 'N/A' }}</div>
                </td>
                <td class="px-6 py-4 text-sm font-medium text-amber-600">â‚¹{{ c.amountClaimed | number:'1.2-2' }}</td>
                <td class="px-6 py-4">
                  <span class="inline-flex items-center rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-medium text-amber-800 ring-1 ring-amber-600/20">
                    {{ c.status }}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <div class="flex flex-wrap gap-2">
                    <!-- Edit Claim -->
                    <button (click)="openEditClaim(c)" class="p-2 text-green-600 hover:text-green-900 hover:bg-green-50 rounded-lg transition-colors" aria-label="Edit claim" title="Edit">
                      <i class="fas fa-edit w-5 h-5"></i>
                    </button>
                    <button (click)="approve(c._id)" class="p-2 text-green-600 hover:text-green-900 hover:bg-green-50 rounded-lg transition-colors" aria-label="Approve claim" title="Approve">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                      </svg>
                    </button>
                    <button (click)="reject(c._id)" class="p-2 text-red-600 hover:text-red-900 hover:bg-red-50 rounded-lg transition-colors" aria-label="Reject claim" title="Reject">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                    <button (click)="openClaimView(c)" class="p-2 text-blue-600 hover:text-blue-900 hover:bg-blue-50 rounded-lg transition-colors" aria-label="View claim" title="View">
                      <i class="fas fa-eye w-5 h-5"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noPendingClaimsBlock>
          <div class="p-8 text-center text-sm text-slate-600">No pending claims found. Claims awaiting approval will appear here.</div>
        </ng-template>
      </div>
      
      <!-- Additional Claims Sections -->
      <div class="mt-8">
        <div class="mb-4">
          <h4 class="text-lg font-semibold text-slate-800">Processed Claims</h4>
          <p class="text-sm text-slate-600">View approved and rejected claims</p>
        </div>
        <!-- Processed Claims -->
        <div class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between border-b border-slate-200 p-6">
            <div class="flex items-center gap-3">
              <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-indigo-100 text-indigo-600">
                âš–ï¸
              </div>
              <div>
                <h3 class="text-lg font-semibold text-slate-800">Processed Claims</h3>
                <p class="text-sm text-slate-600">Approved and rejected claims overview</p>
              </div>
            </div>
            
          </div>
          <div *ngIf="processedClaimsError" class="mx-6 mt-4 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 shadow-sm">{{ processedClaimsError }}</div>
          <div class="overflow-hidden">
            <table class="w-full">
              <thead class="bg-slate-50">
                <tr class="divide-x divide-slate-200">
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Claim</th>
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Customer</th>
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Policy</th>
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Amount</th>
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Approved By</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200 bg-white" *ngIf="processedClaims?.length; else noProcessed">
                <tr *ngFor="let c of processedClaims" class="hover:bg-slate-50 transition-colors">
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                      <div class="flex h-8 w-8 items-center justify-center rounded-full text-xs font-medium"
                           [ngClass]="{
                             'bg-emerald-100 text-emerald-600': (c.status || '').toLowerCase() === 'approved',
                             'bg-rose-100 text-rose-600': (c.status || '').toLowerCase() === 'rejected'
                           }">
                        <span *ngIf="(c.status || '').toLowerCase() === 'approved'">âœ“</span>
                        <span *ngIf="(c.status || '').toLowerCase() === 'rejected'">âœ•</span>
                      </div>
                      <div>
                        <div class="text-sm font-medium text-slate-800">{{ c._id }}</div>
                        <div class="text-xs text-slate-500">{{ c.incidentDate | date:'mediumDate' }}</div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 text-sm text-slate-700">{{ c.userId?.name || c.userId?.email || c.userId }}</td>
                  <td class="px-6 py-4">
                    <div class="text-sm font-medium text-slate-800">{{ c.userPolicyId?.policyProductId?.code || 'N/A' }}</div>
                    <div class="text-xs text-slate-500">{{ c.userPolicyId?.policyProductId?.title || 'N/A' }}</div>
                  </td>
                  <td class="px-6 py-4 text-sm font-medium"
                      [ngClass]="{
                        'text-emerald-600': (c.status || '').toLowerCase() === 'approved',
                        'text-rose-600': (c.status || '').toLowerCase() === 'rejected'
                      }">
                    â‚¹{{ c.amountClaimed | number:'1.2-2' }}
                  </td>
                  <td class="px-6 py-4">
                    <span [ngClass]="{
                      'bg-emerald-100 text-emerald-800 ring-emerald-600/20': (c.status || '').toLowerCase() === 'approved',
                      'bg-rose-100 text-rose-800 ring-rose-600/20': (c.status || '').toLowerCase() === 'rejected'
                    }" class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ring-1">
                      {{ c.status }}
                    </span>
                  </td>
                  <td class="px-6 py-4">
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ring-1"
                          [ngClass]="verificationService.getVerificationTypeClasses(c.verificationType)">
                      {{ verificationService.getVerificationTypeDisplay(c.verificationType) }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
            <ng-template #noProcessed>
              <div class="p-8 text-center text-sm text-slate-600">No processed claims found.</div>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- All Claims History -->
      <div class="mt-8">
        <div class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between border-b border-slate-200 p-6">
            <div class="flex items-center gap-3">
              <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-slate-100 text-slate-600">
                ðŸ“‹
              </div>
              <div>
                <h3 class="text-lg font-semibold text-slate-800">All Claims History</h3>
                <p class="text-sm text-slate-600">Complete claims record</p>
              </div>
            </div>
            
          </div>
          <div *ngIf="allClaimsError" class="mx-6 mt-4 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 shadow-sm">{{ allClaimsError }}</div>
          <div class="overflow-hidden">
            <table class="w-full">
              <thead class="bg-slate-50">
                <tr class="divide-x divide-slate-200">
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Claim</th>
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Customer</th>
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Policy</th>
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Amount</th>
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Status</th>
                  <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wide text-slate-600">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200 bg-white" *ngIf="allClaims?.length; else noAllClaims">
                <tr *ngFor="let c of allClaims" class="hover:bg-slate-50 transition-colors">
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                      <div class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 text-slate-600 text-xs font-medium">
                        ðŸ“‹
                      </div>
                      <div>
                        <div class="text-sm font-medium text-slate-800">{{ c._id }}</div>
                        <div class="text-xs text-slate-500">{{ c.incidentDate | date:'mediumDate' }}</div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 text-sm text-slate-700">{{ c.userId?.name || c.userId?.email || c.userId }}</td>
                  <td class="px-6 py-4">
                    <div class="text-sm font-medium text-slate-800">{{ c.userPolicyId?.policyProductId?.code || 'N/A' }}</div>
                    <div class="text-xs text-slate-500">{{ c.userPolicyId?.policyProductId?.title || 'N/A' }}</div>
                  </td>
                  <td class="px-6 py-4 text-sm font-medium text-slate-800">â‚¹{{ c.amountClaimed | number:'1.2-2' }}</td>
                  <td class="px-6 py-4">
                    <span [ngClass]="{
                      'bg-amber-100 text-amber-800 ring-amber-600/20': (c.status || '').toLowerCase() === 'pending',
                      'bg-emerald-100 text-emerald-800 ring-emerald-600/20': (c.status || '').toLowerCase() === 'approved',
                      'bg-rose-100 text-rose-800 ring-rose-600/20': (c.status || '').toLowerCase() === 'rejected'
                    }" class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ring-1">
                      {{ c.status }}
                    </span>
                  </td>
                  <td class="px-6 py-4">
                    <button (click)="openClaimView(c)" class="p-2 text-indigo-600 hover:text-indigo-900 hover:bg-indigo-50 rounded-lg transition-colors" aria-label="View claim" title="View">
                      <i class="fas fa-eye w-5 h-5"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <ng-template #noAllClaims>
              <div class="p-8 text-center text-sm text-slate-600">No claims found.</div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>
    

  <!-- Agent View Modal -->
    <div *ngIf="showAgentViewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="closeAgentViewModal()">
      <div class="w-full max-w-lg rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-800">Agent Details</h3>
          <button (click)="closeAgentViewModal()" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800">âœ•</button>
        </div>
        <div class="grid grid-cols-1 gap-3 text-sm">
          <div><span class="font-medium text-slate-700">Agent ID:</span> {{ selectedAgentView?._id }}</div>
          <div><span class="font-medium text-slate-700">Agent Code:</span> {{ selectedAgentView?.agentCode || 'â€”' }}</div>
          <div><span class="font-medium text-slate-700">Name:</span> {{ selectedAgentView?.name }}</div>
          <div><span class="font-medium text-slate-700">Email:</span> {{ selectedAgentView?.email }}</div>
        </div>
        <div class="mt-6 flex justify-end">
          <button (click)="closeAgentViewModal()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200">Close</button>
        </div>
      </div>
    </div>

    <!-- Policy Product View Modal -->
    <div *ngIf="showPolicyProductViewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="closePolicyProductViewModal()">
      <div class="w-full max-w-2xl rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-800">Policy Product Details</h3>
          <button (click)="closePolicyProductViewModal()" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800">âœ•</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm" *ngIf="selectedPolicyProductView as p">
          <div class="space-y-1">
            <div><span class="font-medium text-slate-700">Code:</span> {{ p.code }}</div>
            <div><span class="font-medium text-slate-700">Title:</span> {{ p.title }}</div>
            <div><span class="font-medium text-slate-700">Premium:</span> â‚¹{{ p.premium }}</div>
            <div><span class="font-medium text-slate-700">Term:</span> {{ p.termMonths }} months</div>
          </div>
          <div class="space-y-1">
            <div><span class="font-medium text-slate-700">Min Sum Insured:</span> â‚¹{{ p.minSumInsured ?? 0 }}</div>
            <div><span class="font-medium text-slate-700">Max Sum Insured:</span> â‚¹{{ p.maxSumInsured ?? 0 }}</div>
            <div><span class="font-medium text-slate-700">Assigned Agent:</span> {{ p.assignedAgentName || 'â€”' }}</div>
          </div>
          <div class="md:col-span-2">
            <div class="mt-2 text-[13px] text-slate-700 whitespace-pre-line"><span class="font-medium text-slate-700">Description:</span> {{ p.description || 'â€”' }}</div>
          </div>
        </div>
        <div class="mt-6 flex justify-end">
          <button (click)="closePolicyProductViewModal()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200">Close</button>
        </div>
      </div>
    </div>

    <!-- Claim View Modal -->
    <div *ngIf="showClaimViewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="closeClaimViewModal()">
      <div class="w-full max-w-2xl rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-800">Claim Details</h3>
          <button (click)="closeClaimViewModal()" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800">âœ•</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm" *ngIf="selectedClaimView as c">
          <div class="space-y-1">
            <div><span class="font-medium text-slate-700">Claim ID:</span> {{ c._id }}</div>
            <div><span class="font-medium text-slate-700">User:</span> {{ c.userId?.name || c.userId?.email || c.userId }}</div>
            <div><span class="font-medium text-slate-700">Policy:</span> {{ c.userPolicyId?._id || c.userPolicyId }}</div>
            <div><span class="font-medium text-slate-700">Status:</span> {{ c.status }}</div>
          </div>
          <div class="space-y-1">
            <div><span class="font-medium text-slate-700">Incident Date:</span> {{ c.incidentDate | date: 'mediumDate' }}</div>
            <div><span class="font-medium text-slate-700">Amount Claimed:</span> â‚¹{{ c.amountClaimed }}</div>
            <div><span class="font-medium text-slate-700">Decision Notes:</span> {{ c.decisionNotes || 'â€”' }}</div>
          </div>
          <div class="md:col-span-2">
            <div class="mt-2 text-[13px] text-slate-700 whitespace-pre-line"><span class="font-medium text-slate-700">Description:</span> {{ c.description || 'â€”' }}</div>
          </div>
        </div>
        <div class="mt-6 flex justify-end">
          <button (click)="closeClaimViewModal()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200">Close</button>
        </div>
      </div>
    </div>

  <!-- Confirmation Modal -->
  <div *ngIf="showConfirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="cancelAction()">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
      <div class="mb-4 flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-full"
          [ngClass]="{
            'bg-emerald-100': pendingAction?.action?.includes('approve'),
            'bg-rose-100': pendingAction?.action?.includes('reject')
          }">
          <svg class="h-5 w-5" 
            [ngClass]="{
              'text-emerald-600': pendingAction?.action?.includes('approve'),
              'text-rose-600': pendingAction?.action?.includes('reject')
            }" 
            fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path *ngIf="pendingAction?.action?.includes('approve')" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            <path *ngIf="pendingAction?.action?.includes('reject')" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-slate-800">{{ confirmModalData?.title }}</h3>
      </div>
      <div class="mb-6">
        <p class="text-slate-600 mb-3">{{ confirmModalData?.message }}</p>
        <div class="bg-slate-50 rounded-lg p-3 text-sm text-slate-700">
          <div *ngIf="confirmModalData?.detail1">{{ confirmModalData?.detail1 }}</div>
          <div *ngIf="confirmModalData?.detail2">{{ confirmModalData?.detail2 }}</div>
        </div>
      </div>
      <div class="flex justify-end gap-3">
        <button (click)="cancelAction()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200 transition-colors">
          Cancel
        </button>
        <button (click)="confirmAction()" class="rounded-full px-4 py-2 text-white shadow-sm transition-colors"
          [ngClass]="{
            'bg-emerald-600 hover:bg-emerald-700': pendingAction?.action?.includes('approve'),
            'bg-rose-600 hover:bg-rose-700': pendingAction?.action?.includes('reject')
          }">
          {{ pendingAction?.action?.includes('approve') ? 'Approve' : 'Reject' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Claim Edit Modal -->
  <div *ngIf="editingClaim" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="closeEditClaim()">
    <div class="w-full max-w-xl rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Edit Claim</h3>
        <button (click)="closeEditClaim()" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800">âœ•</button>
      </div>
      <div class="grid grid-cols-1 gap-3 text-sm">
        <div>
          <label class="mb-1 block text-sm font-medium text-slate-700">Incident Date</label>
          <input type="date" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="claimForm.incidentDate" [ngModelOptions]="{standalone:true}" />
        </div>
        <div>
          <label class="mb-1 block text-sm font-medium text-slate-700">Amount Claimed</label>
          <input type="number" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="claimForm.amountClaimed" [ngModelOptions]="{standalone:true}" placeholder="0" />
        </div>
        <div>
          <label class="mb-1 block text-sm font-medium text-slate-700">Description</label>
          <textarea rows="3" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="claimForm.description" [ngModelOptions]="{standalone:true}" placeholder="Describe the incident..."></textarea>
        </div>
        <div>
          <label class="mb-1 block text-sm font-medium text-slate-700">Decision Notes</label>
          <textarea rows="2" class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="claimForm.decisionNotes" [ngModelOptions]="{standalone:true}" placeholder="Internal notes (optional)"></textarea>
        </div>
        <div *ngIf="actionError" class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800">{{ actionError }}</div>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button (click)="closeEditClaim()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200">Cancel</button>
        <button (click)="saveClaimEdit()" class="rounded-full bg-emerald-600 px-4 py-2 text-white shadow-sm ring-1 ring-emerald-500/50 hover:bg-emerald-700">Save</button>
      </div>
    </div>
  </div>

  <!-- Unassign Agent Confirmation Modal (global) -->
  <div *ngIf="showUnassignModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="!unassignLoading && closeUnassignModal()">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Remove Assigned Agent</h3>
        <button (click)="closeUnassignModal()" [disabled]="unassignLoading" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800 disabled:opacity-50">âœ•</button>
      </div>
      <div class="space-y-4 text-sm text-slate-700">
        <p>Are you sure you want to remove the agent from this policy?</p>
        <div class="rounded-xl bg-slate-50 p-4 text-xs text-slate-600 ring-1 ring-slate-200" *ngIf="unassignTarget">
          <div><span class="font-semibold text-slate-700">Policy Code:</span> {{ unassignTarget?.code }}</div>
          <div><span class="font-semibold text-slate-700">Policy Title:</span> {{ unassignTarget?.title || 'â€”' }}</div>
          <div><span class="font-semibold text-slate-700">Current Agent:</span> {{ unassignTarget?.assignedAgentName || 'â€”' }}</div>
        </div>
        <div *ngIf="unassignError" class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800">{{ unassignError }}</div>
        <div class="flex items-center gap-2 text-xs" *ngIf="unassignLoading">
          <svg class="h-4 w-4 animate-spin text-indigo-600" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
          </svg>
          <span>Removing...</span>
        </div>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button (click)="closeUnassignModal()" [disabled]="unassignLoading" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200 disabled:opacity-50">Cancel</button>
        <button (click)="confirmUnassignAgent()" [disabled]="unassignLoading" class="rounded-full bg-rose-600 px-4 py-2 text-white shadow-sm ring-1 ring-rose-500/50 hover:bg-rose-700 disabled:opacity-50">{{ unassignLoading ? 'Removing...' : 'Remove' }}</button>
      </div>
    </div>
  </div>

  <!-- Assign Agent Modal (global) -->
  <div *ngIf="showAssignModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="closeAssignModal()">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Assign Agent</h3>
        <button (click)="closeAssignModal()" class="rounded-full p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-800">âœ•</button>
      </div>
      <div class="space-y-4">
        <div class="text-sm text-slate-600">
          <div><span class="font-medium text-slate-700">Policy:</span> {{ selectedPolicy?.title || selectedPolicy?.code }}</div>
          <div *ngIf="selectedPolicy?.assignedAgentName"><span class="font-medium text-slate-700">Current Agent:</span> {{ selectedPolicy?.assignedAgentName }}</div>
        </div>
        <div>
          <label class="mb-1 block text-sm font-medium text-slate-700">Select Agent</label>
          <select class="w-full rounded-xl border border-slate-300 p-2.5" [(ngModel)]="selectedAgentId" [ngModelOptions]="{standalone:true}">
            <option value="">-- choose agent --</option>
            <option *ngFor="let a of agentList" [value]="a._id">{{ a.name }} ({{ a.email }})</option>
          </select>
        </div>
        <div *ngIf="assignError" class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 text-sm shadow-sm">{{ assignError }}</div>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button (click)="closeAssignModal()" class="rounded-full bg-slate-100 px-4 py-2 text-slate-700 ring-1 ring-slate-200 hover:bg-slate-200">Cancel</button>
        <button (click)="assignAgent()" class="rounded-full bg-indigo-600 px-4 py-2 text-white shadow-sm ring-1 ring-indigo-500/50 hover:bg-indigo-700">Assign</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div *ngIf="showSuccessModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" (click)="closeSuccessModal()">
    <div class="w-full max-w-md rounded-2xl bg-white p-6 shadow-xl ring-1 ring-slate-200" (click)="$event.stopPropagation()">
      <div class="mb-4 flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-100">
          <svg class="h-5 w-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-slate-800">{{ successModalData?.title }}</h3>
      </div>
      <div class="mb-6">
        <p class="text-slate-600">{{ successModalData?.message }}</p>
      </div>
      <div class="flex justify-end">
        <button (click)="closeSuccessModal()" class="rounded-full bg-emerald-600 px-4 py-2 text-white shadow-sm hover:bg-emerald-700 transition-colors">
          OK
        </button>
      </div>
    </div>
  </div>
</div>
